<div id="chart"></div>

<script src="https://d3js.org/d3.v3.js"></script>
<svg id="svg2" style="margin: 0 auto; display: block;"></svg>
<script type="text/javascript">
    var node_width = 80;
    var node_height = 30;

    var dataset = {{ dataset | tojson | safe }}
    var nodes = dataset["nodes"]
    var links = dataset["links"]
    var pathway = dataset["pathway"]
    var width = "{{ width }}"
    var height = "{{ height }}"


    function arrowHeadType(gpmlArrowType) {
        switch (gpmlArrowType) {
            case "Arrow":
            case "mim-conversion":
                return "url(#marker-arrow)";
            case "mim-catalysis":
                return "url(#marker-circle)";
            case "mim-inhibition":
                return "url(#marker-pipe)";
        }
        return '';
    }


    var svg = d3.select("#svg2")
        .attr("width", width)
        .attr("height", height)
        .style("background-color", "#fff");

    var titleOffset = 50;

    svg.selectAll("line")
        .data(links)
        .enter().append("line")
        .attr("class", "element-in-body")
        .attr("x1", function (d, i) { return d.points[0].X + d.points[0].RelX })
        .attr("y1", function (d, i) { return d.points[0].Y + d.points[0].RelY })
        .attr("x2", function (d, i) { return d.points[1].X + d.points[1].RelX })
        .attr("y2", function (d, i) { return d.points[1].Y + d.points[1].RelY })
        .attr('stroke', 'black')
        .attr("marker-start", d => arrowHeadType(d.points[0].ArrowHead))
        .attr("marker-end", d => arrowHeadType(d.points[1].ArrowHead))
        .attr('fill', 'none');

    svg.selectAll("rect")
        .data(nodes)
        .enter().append("rect")
        .attr("class", "element-in-body")
        .attr("x", (d) => d.CenterX - d.Width / 2)
        .attr("y", (d) => d.CenterY - d.Height / 2)
        .attr("width", d => d.Width)
        .attr("height", d => d.Height)
        .attr("fill", "white")
        .style("stroke", d => `#${d.Color}`)
        .on("click", function (d) {
            onIdClicked(d[2])
        });

    
    var contentGroup = svg.append("g")
        .attr("class", "content-group")
        .attr("transform", "translate(0," + titleOffset + ")");

    svg.selectAll(".element-in-body")
    .each(function() {
        contentGroup.node().appendChild(this);
    });

    var markerBoxWidth = 10, markerBoxHeight = 10, refXFactor = 1, refYFactor = 0.5;
    var arrowPoints = [
        [markerBoxWidth, markerBoxHeight / 2],
        [0, markerBoxHeight],
        [0, 0]
    ]
    var refX = markerBoxWidth * refXFactor;
    var refY = markerBoxHeight * refYFactor;

    svg
        .append("defs")
        .append("marker")
        .attr("id", "marker-arrow")
        .attr("viewBox", [0, 0, markerBoxWidth, markerBoxHeight])
        .attr("refX", refX)
        .attr("refY", refY)
        .attr("markerWidth", markerBoxWidth)
        .attr("markerHeight", markerBoxHeight)
        .attr("orient", "auto-start-reverse")
        .append("path")
        .attr("d", `M ${markerBoxWidth} ${markerBoxHeight / 2} L 0 ${markerBoxHeight} L 0 0 z`)
        .attr("fill", "#000000");


    svg
        .append("defs")
        .append("marker")
        .attr("id", "marker-circle")
        .attr("viewBox", [0, 0, markerBoxWidth, markerBoxHeight])
        .attr("refX", refX)
        .attr("refY", refY)
        .attr("markerWidth", markerBoxWidth)
        .attr("markerHeight", markerBoxHeight)
        .attr("orient", "auto-start-reverse")
        .append('circle')
        .attr('cx', markerBoxWidth / 2)
        .attr('cy', markerBoxHeight / 2)
        .attr('r', markerBoxWidth / 2)
        .attr("stroke", "#000000")
        .attr("fill", "white");


    svg.selectAll("text")
        .data(nodes)
        .enter().append("text")
        .attr("class", "element-in-body")
        .attr("x", (d) => d.CenterX)
        .attr("y", (d) => d.CenterY + titleOffset)
        .attr("stroke", d => `#${d.Color}`)
        .text(d => d.TextLabel)
        .style("text-anchor", "middle")
        .style("dominant-baseline", "central")
        .on("click", function (d) {
            onIdClicked(d.TextLabel)
        });



    svg.append("text")
        .attr("x", 10)
        .attr("y", 10)
        .attr("class", "pathwayName")
        .attr("stroke", "black")
        .text(`Name:${pathway.Name}`);


    svg.append("text")
        .attr("x", 10)
        .attr("y", 10)
        .attr("dy", "1.5em")
        .attr("class", "pathwayVersion")
        .attr("stroke", "black")
        .text(`Last Modified: ${pathway.Version}`)

    svg.append("text")
        .attr("x", 10)
        .attr("y", 10)
        .attr("dy", "3em")
        .attr("class", "pathwayOrganism")
        .attr("stroke", "black")
        .text(`Organism:${pathway.Organism}`)



    var arcs = dataset["shapes"].filter(d => d.ShapeType == "Arc")


    svg.selectAll("path.arc")
        .data(arcs)
        .enter().append("path")
        .attr("class", "arc")   
        // d3のArcでWidthとHeightを指定すると、楕円になるので、scaleで調整する
        .attr("transform", d => { 
            let scaleWidth = Math.max(d.Width / d.Height, 1);
            let scaleHeight = Math.max(d.Height / d.Width, 1);
            return `translate(${d.CenterX},${d.CenterY + titleOffset}) scale(${scaleWidth},${scaleHeight})`;
        })
        .attr("d", d => { 
            let width = d.Width;
            let height = d.Height;            
            let radius = Math.min(width, height) / 2;
            return d3.svg.arc()({
                innerRadius: radius,
                outerRadius: radius + 1,
                startAngle: -Math.PI / 2,
                endAngle: Math.PI / 2
            })
        });


    function onIdClicked(gid) {
        // 下記の記述でグローバル変数をJupyterのPythonにわたすことはできる
        //Jupyter.notebook.kernel.execute("gid='AT5G23350'");
        //kernel.execute('graphId=10');
        Jupyter.notebook.kernel.execute(`gid='${gid}'`);


        // 相対位置でcellを指定しcellを実行する場合。フォーカスが当たっていないと実行位置がずれるため使えない
        //var cell = Jupyter.notebook.select_next().get_selected_cell()
        //cell.execute()

        // cellのindexを指定しtableのアップデートを実行する場合。設定で変更できると良いかも（必要ないかもだが）
        Jupyter.notebook.execute_cells([2])
    }
</script>